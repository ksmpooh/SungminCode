## 20240627
## STR tool test
## dumpSTR DB : http://hgdownload.cse.ucsc.edu/goldenpath/hg38/database/genomicSuperDups.txt.gz


cd /ADATA/smkim/pangenome/01.wgs/str_test


ref : /BDATA/smkim/HLAseq/REF/human_GRCh38_no_alt_analysis_set/human_GRCh38_no_alt_analysis_set.basic.fasta
bam: /ADATA/smkim/pangenome/01.wgs/01.bam/NIH20N2000078.bam
bed: /BDATA/smkim/STR/EH/resources/eh.v5_w_gangstr.v13.polymorphic.JSONtoBED.bed
eh.vcf: /ADATA/smkim/pangenome/01.wgs/str_test/NIH20N2000078.EH.vcf.gz

##eh
/BDATA/smkim/TOOLs/tool_db/RepeatCatalogs/hg38/polymorphic_STR.json

/BDATA/smkim/STR/EH/ExpansionHunter/bin/ExpansionHunter \
        --reads /ADATA/smkim/pangenome/01.wgs/01.bam/NIH20N2000078.bam \
        --reference /BDATA/smkim/HLAseq/REF/human_GRCh38_no_alt_analysis_set/human_GRCh38_no_alt_analysis_set.basic.fasta \
        --analysis-mode streaming \
        --threads 72 \
        --variant-catalog /BDATA/smkim/TOOLs/tool_db/RepeatCatalogs/hg38/polymorphic_STR.json \
        --output-prefix NIH20N2000078.EH_new 2 > EH.log

##

ensembletr --out output.vcf
           --ref ref.fa
           --vcfs vcf1.vcf,vcf2.vcf,...


time ensembletr --out NIH20N2000078.ensembletr.vcf --ref /BDATA/smkim/HLAseq/REF/human_GRCh38_no_alt_analysis_set/human_GRCh38_no_alt_analysis_set.basic.fasta --vcf NIH20N2000078.EH.vcf.gz
time ensembletr --vcf /BDATA/smkim/STR/EH_shortread/02.gz/NIH20N2038392.EH.vcf.gz --ref /BDATA/smkim/HLAseq/REF/human_GRCh38_no_alt_analysis_set/human_GRCh38_no_alt_analysis_set.basic.fasta --out test1.EH.vcf
time ensembletr --vcf NIH20N2000078.EH.vcf.gz,NIH20N2000078.HipSTR.vcf.gz --ref /BDATA/smkim/HLAseq/REF/human_GRCh38_no_alt_analysis_set/human_GRCh38_no_alt_analysis_set.basic.fasta --out NIH20N2000078.HipSTR.ensembleTR.vcf


Analysing record cluster ranged in chr4:39337436-39337473.
Traceback (most recent call last):


time ensembletr --vcf NIH20N2000078.EH_new.vcf.gz --ref /BDATA/smkim/HLAseq/REF/human_GRCh38_no_alt_analysis_set/human_GRCh38_no_alt_analysis_set.basic.fasta --out NIH20N2000078.EH_new.ensembleTR.vcf




## GangSTR: 
db: /BDATA/smkim/TOOLs/tool_db/gangSTR/hg38_ver13.bed


/BDATA/smkim/TOOLs/str_tool/GangSTR-2.5.0-Source/bin/GangSTR
GangSTR --bam file.bam 
        --ref ref.fa 
        --regions regions.bed 
        --out outprefix 

time /BDATA/smkim/TOOLs/str_tool/GangSTR-2.5.0-Source/bin/GangSTR \
--bam /ADATA/smkim/pangenome/01.wgs/01.bam/NIH20N2000078.bam \
--ref /BDATA/smkim/HLAseq/REF/human_GRCh38_no_alt_analysis_set/human_GRCh38_no_alt_analysis_set.basic.fasta \
--regions /BDATA/smkim/TOOLs/tool_db/gangSTR/gangstr.v13.polymorphic_w_eh.v5_offtarget.exp10_p05.top5_no_segdup.fast_2s.bed \
--out NIH20N2000078.GangSTR

[GangSTR-2.5.0] ProgressMeter:  Genotyper Results:  7, 7        likelihood = 217.475

real    497m11.639s
user    496m36.121s
sys     0m31.046s


## HipSTR
/BDATA/smkim/TOOLs/str_tool/HipSTR/HipSTR
/BDATA/smkim/TOOLs/tool_db/HipSTR/hg38.hipstr_reference.bed
./HipSTR --bams          run1.bam,run2.bam,run3.bam,run4.bam
         --fasta         genome.fa
         --regions       str_regions.bed
         --str-vcf       str_calls.vcf.gz


time /BDATA/smkim/TOOLs/str_tool/HipSTR/HipSTR \
--bams /ADATA/smkim/pangenome/01.wgs/01.bam/NIH20N2000078.bam \
--fasta /BDATA/smkim/HLAseq/REF/human_GRCh38_no_alt_analysis_set/human_GRCh38_no_alt_analysis_set.basic.fasta \
--regions /BDATA/smkim/TOOLs/tool_db/HipSTR/hg38.hipstr_reference.bed \
--str-vcf NIH20N2000078.HipSTR.vcf.gz


Approximate timing breakdown
 BAM seek time       = 0.80094 seconds
 Read filtering      = 3324.68 seconds
 SNP info extraction = 44.3764 seconds
 Stutter estimation  = 0.302847 seconds
 Genotyping          = 70.2476 seconds
         Left alignment        = 4.53917 seconds
         Haplotype generation  = 0.166445 seconds
         Haplotype alignment   = 48.1001 seconds
         Flank assembly        = 0.376884 seconds
         Posterior computation = 0.032084 seconds
         Alignment traceback   = 16.6029 seconds
HipSTR execution finished: Total runtime = 3839.1 sec
-----------------



real    63m59.903s
user    62m38.853s
sys     1m20.262s


time ensembletr --vcfs NIH20N2000078.EH.vcf.gz,NIH20N2000078.HipSTR.vcf.gz \
--out NIH20N2000078.merge.vcf --ref /BDATA/smkim/HLAseq/REF/human_GRCh38_no_alt_analysis_set/human_GRCh38_no_alt_analysis_set.basic.fasta


약 2분



###

dumpSTR \
  --vcf <vcf file> \
  --out <string> \
  [filter options]

dumpSTR --vcf NIH20N2000078.EH.vcf.gz \
--out NIH20N2000078.EH.dumpSTR.vcf.gz \
--min-locus-callrate 0.7 \
--min-locus-hwep 0.000001 \
--filter-regions-names SEGDUP

--filter-regions hg38_segdup.sorted.bed.gz 

        
dumpSTR --vcf NIH20N2000078.EH.vcf.gz \
--out NIH20N2000078.EH.dumpSTR.vcf.gz \
--min-locus-callrate 0.7 \
--min-locus-hwep 0.000001 \
--filter-regions /BDATA/smkim/TOOLs/tool_db/hg38_segdup.sorted.bed.gz \
--filter-regions-names SEGDUP


/BDATA/smkim/TOOLs/tool_db/genomicSuperDups.txt

time ensembletr --vcf NIH20N2000078.EH.dumpSTR.vcf.gz.vcf \
--out NIH20N2000078.EH.dumpSTR.ensembleTR.vcf --ref /BDATA/smkim/HLAseq/REF/human_GRCh38_no_alt_analysis_set/human_GRCh38_no_alt_analysis_set.basic.fasta


분석 시간
EH: 5분 이내, multi-threads 가능
gangSTR: multi-threads 불가능.. 약 8시간
HipSTR: multi-threads 불가능.. 약 1시간

ensembleTR: EH 결과만 했을때, 약 1분
ensembleTR: EH+gangSTR+HipSTR, 약 2분


guo DB: 321,298개
ensembleTR 기본 DB: 174293개


sort -k1,1V -k2,2n -k3,3n guo.sup1.sheet1.dup.bed > guo.sup1.sheet1.dup.sort.bed

/BDATA/smkim/STR/db/guo.sup1.sheet1.dup.sort.bed.gz


time dumpSTR --vcf NIH20N2000078.EH.vcf.gz \
--out NIH20N2000078.EH.dumpSTR.vcf.gz \
--min-locus-callrate 0.7 \
--min-locus-hwep 0.000001 \
--filter-regions /BDATA/smkim/STR/db/guo.sup1.sheet1.dup.sort.bed.gz \
--filter-regions-names SEGDUP

real    40m25.634s
user    40m15.810s
sys     0m23.181s

## error
time ensembletr --vcf NIH20N2000078.EH.dumpSTR.vcf.gz.vcf \
--out NIH20N2000078.EH.dumpSTR.ensembleTR.vcf --ref /BDATA/smkim/HLAseq/REF/human_GRCh38_no_alt_analysis_set/human_GRCh38_no_alt_analysis_set.basic.fasta

## 추가 확인..
cd /ADATA/smkim/pangenome/01.wgs/str_test

bcftools query -f '%CHROM\t%POS\t%END\tSEGDUP\n' NIH20N2000078.EH.dumpSTR.vcf.gz.vcf.gz | uniq -c | awk '$1==2{OFS="\t";print $2,$3,$4,$5}' > /BDATA/smkim/STR/db/eh.dupSTR.additional.txt

cd /BDATA/smkim/STR/db
cat guo.sup1.sheet1.dup.bed eh.dupSTR.additional.txt | sort -k1,1V -k2,2n -k3,3n > guo.sup1.sheet1.sort_add.bed


time dumpSTR --vcf NIH20N2000078.EH.vcf.gz \
--out NIH20N2000078.EH.dumpSTR.vcf.gz \
--min-locus-callrate 0.7 \
--min-locus-hwep 0.000001 \
--filter-regions /BDATA/smkim/STR/db/guo.sup1.sheet1.sort_add.bed.gz \
--filter-regions-names SEGDUP

bgzip NIH20N2000078.EH.dumpSTR.vcf.gz.vcf;tabix NIH20N2000078.EH.dumpSTR.vcf.gz.vcf.gz

time ensembletr --vcf NIH20N2000078.EH.dumpSTR.vcf.gz.vcf.gz \
--out NIH20N2000078.EH.dumpSTR.ensembleTR.vcf --ref /BDATA/smkim/HLAseq/REF/human_GRCh38_no_alt_analysis_set/human_GRCh38_no_alt_analysis_set.basic.fasta


 bcftools view -T ^/BDATA/smkim/STR/db/eh.dupSTR.additional.txt NIH20N2000078.EH.dumpSTR.vcf.gz.vcf.gz -Oz -o NIH20N2000078.EH.dumpSTR.rmadd.vcf.gz


time ensembletr --vcf NIH20N2000078.EH.dumpSTR.rmadd.vcf.gz \
--out NIH20N2000078.EH.dumpSTR.rmadd.ensembleTR.vcf --ref /BDATA/smkim/HLAseq/REF/human_GRCh38_no_alt_analysis_set/human_GRCh38_no_alt_analysis_set.basic.fasta

Analysing record cluster ranged in chr4:41735638-41735665.
Analysing record cluster ranged in chr4:41736719-41736738.
Analysing record cluster ranged in chr4:41745775-41745795.


bcftools query -f '%CHROM\t%POS\t%POS\t%RU\n' NIH20N2000078.EH.dumpSTR.vcf.gz.vcf.gz | awk '$4 !~ /^[ATCG]+$/'
## 아래 추가로 지우기
chr4    39348424        39348424        AARRG
chr4    41745972        41745972        GCN

bcftools view -T ^/BDATA/smkim/STR/db/eh.dupSTR.additional.txt NIH20N2000078.EH.dumpSTR.vcf.gz.vcf.gz -Oz -o NIH20N2000078.EH.dumpSTR.rmadd.vcf.gz
tabix -f -p vcf NIH20N2000078.EH.dumpSTR.rmadd.vcf.gz

time ensembletr --vcf NIH20N2000078.EH.dumpSTR.rmadd.vcf.gz \
--out NIH20N2000078.EH.dumpSTR.rmadd.ensembleTR.vcf --ref /BDATA/smkim/HLAseq/REF/human_GRCh38_no_alt_analysis_set/human_GRCh38_no_alt_analysis_set.basic.fasta



##############
test
cd /BDATA/smkim/STR/test/trgt_version
###  2-1. TRGT
/BDATA/smkim/TOOLs/trgt-v3.0.0-x86_64-unknown-linux-gnu/trgt
XX
/BDATA/smkim/pangenome/01.revio_refpanel/01.mapping/NIH23J3016218_sorted.bam

### new DB
/BDATA/smkim/TOOLs/trgt-v3.0.0-x86_64-unknown-linux-gnu/trgt \
-v genotype -t 64 -k XX \
--genome /BDATA/smkim/HLAseq/REF/human_GRCh38_no_alt_analysis_set/human_GRCh38_no_alt_analysis_set.basic.fasta \
--repeats /BDATA/smkim/STR/db/STRchive/data/STRchive-disease-loci.hg38.TRGT.bed \
--reads /BDATA/smkim/pangenome/01.revio_refpanel/01.mapping/NIH23J3016218_sorted.bam \
--output-prefix NIH23J3016218.trgt.output


bcftools sort -Ob -o NIH23J3016218.trgt.output.sorted.vcf.gz NIH23J3016218.trgt.output.vcf.gz
bcftools index NIH23J3016218.trgt.output.sorted.vcf.gz

samtools sort -o NIH23J3016218.trgt.output.spannin.sorted.bam NIH23J3016218.trgt.output.spanning.bam
samtools index NIH23J3016218.trgt.output.spannin.sorted.bam

### OLD db
/BDATA/smkim/STR/trgt/db/pathogenic_repeats.hg38.bed

/BDATA/smkim/TOOLs/trgt-v3.0.0-x86_64-unknown-linux-gnu/trgt \
-v genotype -t 64 -k XX \
--genome /BDATA/smkim/HLAseq/REF/human_GRCh38_no_alt_analysis_set/human_GRCh38_no_alt_analysis_set.basic.fasta \
--repeats /BDATA/smkim/STR/trgt/db/pathogenic_repeats.hg38.bed \
--reads /BDATA/smkim/pangenome/01.revio_refpanel/01.mapping/NIH23J3016218_sorted.bam \
--output-prefix NIH23J3016218.trgt_oldDB.output


bcftools sort -Ob -o NIH23J3016218.trgt_oldDB.output.sorted.vcf.gz NIH23J3016218.trgt_oldDB.output.vcf.gz
bcftools index NIH23J3016218.trgt_oldDB.output.sorted.vcf.gz 

samtools sort -o NIH23J3016218.trgt_oldDB.output.spanning.sorted.bam NIH23J3016218.trgt_oldDB.output.spanning.bam
samtools index NIH23J3016218.trgt_oldDB.output.spanning.sorted.bam



/BDATA/smkim/TOOLs/trgt-v3.0.0-x86_64-unknown-linux-gnu/trgt plot \
    --genome /BDATA/smkim/HLAseq/REF/human_GRCh38_no_alt_analysis_set/human_GRCh38_no_alt_analysis_set.basic.fasta \
    --repeats /BDATA/smkim/STR/trgt/db/pathogenic_repeats.hg38.bed \
    --vcf NIH23J3016218.trgt_oldDB.output.sorted.vcf.gz \
    --spanning-reads NIH23J3016218.trgt_oldDB.output.spanning.sorted.bam \
    --repeat-id HTT \
    --image HTT_old.svg

/BDATA/smkim/TOOLs/trgt-v3.0.0-x86_64-unknown-linux-gnu/trgt plot \
    --genome /BDATA/smkim/HLAseq/REF/human_GRCh38_no_alt_analysis_set/human_GRCh38_no_alt_analysis_set.basic.fasta \
    --repeats /BDATA/smkim/STR/trgt/db/pathogenic_repeats.hg38.bed \
    --vcf NIH23J3016218.trgt_oldDB.output.sorted.vcf.gz \
    --spanning-reads NIH23J3016218.trgt_oldDB.output.spanning.sorted.bam \
    --repeat-id RFC1 \
    --image RFC1_old.svg



/BDATA/smkim/TOOLs/trgt-v3.0.0-x86_64-unknown-linux-gnu/trgt plot \
    --genome /BDATA/smkim/HLAseq/REF/human_GRCh38_no_alt_analysis_set/human_GRCh38_no_alt_analysis_set.basic.fasta \
    --repeats /BDATA/smkim/STR/db/STRchive/data/STRchive-disease-loci.hg38.TRGT.bed \
    --vcf NIH23J3016218.trgt.output.sorted.vcf.gz \
    --spanning-reads NIH23J3016218.trgt.output.spannin.sorted.bam \
    --repeat-id HD_HTT \
    --image HTT.svg





/BDATA/smkim/TOOLs/trgt-v3.0.0-x86_64-unknown-linux-gnu/trgt plot \
    --genome /BDATA/smkim/HLAseq/REF/human_GRCh38_no_alt_analysis_set/human_GRCh38_no_alt_analysis_set.basic.fasta \
    --repeats /BDATA/smkim/STR/db/STRchive/data/STRchive-disease-loci.hg38.TRGT.bed \
    --vcf /BDATA/smkim/STR/trgt/01.trgt_genotype_gangstr.v13_new/02.sort/NIH23J3016218_sorted_trgt_genotype_gangstr.sorted.vcf.gz \
    --spanning-reads NIH23J3016218.trgt.output.spannin.sorted.bam \
    --repeat-id CANVAS_RFC1 \
    --image CANVAS_RFC1.svg





/BDATA/smkim/TOOLs/trgt-v3.0.0-x86_64-unknown-linux-gnu/trgt plot \
    --genome /BDATA/smkim/HLAseq/REF/human_GRCh38_no_alt_analysis_set/human_GRCh38_no_alt_analysis_set.basic.fasta \
    --repeats /BDATA/smkim/STR/db/STRchive/data/STRchive-disease-loci.hg38.TRGT.bed \
    --vcf NIH23J3016218.trgt.output.sorted.vcf.gz \
    --spanning-reads NIH23J3016218.trgt.output.spannin.sorted.bam \
    --repeat-id JBS_CBL \
    --image JBS_CBL.svg

/BDATA/smkim/TOOLs/trgt-v3.0.0-x86_64-unknown-linux-gnu/trgt plot \
    --genome /BDATA/smkim/HLAseq/REF/human_GRCh38_no_alt_analysis_set/human_GRCh38_no_alt_analysis_set.basic.fasta \
    --repeats /BDATA/smkim/STR/db/STRchive/data/STRchive-disease-loci.hg38.TRGT.bed \
    --vcf NIH23J3016218.trgt.output.sorted.vcf.gz \
    --spanning-reads NIH23J3016218.trgt.output.spannin.sorted.bam \
    --repeat-id SCA37_DAB1 \
    --image SCA37_DAB1.svg


/BDATA/smkim/TOOLs/trgt-v3.0.0-x86_64-unknown-linux-gnu/trgt plot \
    --genome /BDATA/smkim/HLAseq/REF/human_GRCh38_no_alt_analysis_set/human_GRCh38_no_alt_analysis_set.basic.fasta \
    --repeats /BDATA/smkim/STR/trgt/db/pathogenic_repeats.hg38.bed \
    --vcf NIH23J3016218.trgt_oldDB.output.sorted.vcf.gz \
    --spanning-reads NIH23J3016218.trgt_oldDB.output.spanning.sorted.bam \
    --repeat-id CBL \
    --image CBL_old.svg

/BDATA/smkim/TOOLs/trgt-v3.0.0-x86_64-unknown-linux-gnu/trgt plot \
    --genome /BDATA/smkim/HLAseq/REF/human_GRCh38_no_alt_analysis_set/human_GRCh38_no_alt_analysis_set.basic.fasta \
    --repeats /BDATA/smkim/STR/trgt/db/pathogenic_repeats.hg38.bed \
    --vcf NIH23J3016218.trgt_oldDB.output.sorted.vcf.gz \
    --spanning-reads NIH23J3016218.trgt_oldDB.output.spanning.sorted.bam \
    --repeat-id DAB1 \
    --image DAB1_old.svg

./trgt-v1.0.0-x86_64-unknown-linux-gnu/trgt \
    -v genotype \
    -t [num] \ #thread 수
    -k [XX or XY] \ # 성염색체 정보를 정확히 해야.. X 쪽 STR calling이 됨
    --genome [ref.fasta] \ # mapping 할 때 사용한 refernece fasta 
    --repeats [TRGT.bed] \ # STR bed, tool에서 기본적으로 제공하는 DB 사용
    --reads [input.mapped.bam] \ 
    --output-prefix [output] 


###  2-2. QC after TRGT
bcftools sort -Ob -o sample.sorted.vcf.gz sample.vcf.gz
bcftools index sample.sorted.vcf.gz

samtools sort -o sample.spanning.sorted.bam sample.spanning.bam
samtools index sample.spanning.sorted.bam

### 2-3 visualization

./trgt-v1.0.0-x86_64-unknown-linux-gnu/trgt \
    --genome [ref.fasta] \ # mapping 할 때 사용한 refernece fasta 
    --repeats [TRGT.bed] \
    --vcf [TRGT 결과.vcf.gz] \
    --spanning-reads [TRGT 결과.spanning.bam] \
    --repeat-id [STR ID] \ # ex. HTT
    --image [output.svg]